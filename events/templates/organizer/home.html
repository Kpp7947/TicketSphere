{% extends "layout.html" %}
{% load static %}

{% block title %}Organizer{% endblock %}

{% block content %}
<div class="text-white font-semibold">
    <div class="my-10 flex justify-between items-end">
        <div>
            <h1 class="text-4xl font-bold">Event Dashboard</h1>
            <p class="mb-5">
                Total: <span>{{ total }}</span> events
            </p>
            <a href="{% url 'create-event' %}"
                class="font-semibold px-4 py-2 cursor-pointer hover:bg-green-800 bg-green-600 rounded-lg">
                Create Events
            </a>
        </div>
        <div class="w-md flex gap-x-7">
            <div class="relative flex inline-block">
                <button id="dropdownbtn" class="text-lg font-bold hover:text-violet-600">Filter ☰</button>

                <div id="dropdownmenu"
                    class="absolute hidden mt-16 pl-5 py-4 rounded-md text-black bg-white w-[450px] left-1/2 -translate-x-1/3 shadow">
                    <div class="max-h-80 overflow-y-auto">
                        <div class="flex justify-between mr-5 mb-4">
                            <h2 class="text-2xl font-bold">Ticket Price</h2>
                            <button class="closebtn font-semibold text-gray-500 text-lg">✕</button>
                        </div>
                        <div class="grid grid-cols-2 gap-y-2 ml-4">
                            <div class="flex gap-2">
                                {% if price_filter == '' or price_filter == None %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="" checked>
                                {% else %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="">
                                {% endif %}
                                <label class="cursor-pointer" for="all_price">All Price</label>
                            </div>

                            <div class="flex gap-2">
                                {% if price_filter == '1000-5000' %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="1001-5000" checked>
                                {% else %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="1001-5000"> 
                                {% endif %}
                                <label class="cursor-pointer" for="1001-5000">฿1,001 - ฿5,000</label>
                            </div>

                            <div class="flex gap-2">
                                {% if price_filter == '0' %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="0" checked>
                                {% else %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="0">
                                {% endif %}
                                <label class="cursor-pointer" for="0">Free</label>
                            </div>

                            <div class="flex gap-2">
                                {% if price_filter == '5001-10000' %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="5001-10000" checked>
                                {% else %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="5001-10000">
                                {% endif %}
                                <label class="cursor-pointer" for="5001-10000">฿5,001 - ฿10,000</label>
                            </div>

                            <div class="flex gap-2">
                                {% if price_filter == '1-1000' %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="1-1000" checked>
                                {% else %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="1-1000">
                                {% endif %}
                                <label class="cursor-pointer" for="1-1000">฿1 - ฿1,000 </label>
                            </div>

                            <div class="flex gap-2">
                                {% if price_filter == '10001' %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="10001" checked>
                                {% else %}
                                    <input class="cursor-pointer" type="radio" name="price-filter" value="10001">
                                {% endif %}
                                <label class="cursor-pointer" for="10001">฿10,001 +</label>
                            </div>
                        </div>
                        <hr class="border mt-4">
                        <div class="mb-4">
                            <div class="flex mt-4 justify-between items-center mr-5 mb-4">
                                <h2 class="text-2xl font-bold">Category</h2>
                                <button id="clearbtn" class="font-semibold text-gray-500 hover:text-gray-700">Clear</button>
                            </div>
                            <div class="grid grid-cols-2">
                                {% for cat in category %}
                                <label class="block py-2 ml-4 cursor-pointer">
                                    <input type="checkbox" name="category-filter" value="{{ cat.name }}" {% if cat.name in category_filter %} checked {% endif %}> {{ cat.name }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="sticky bottom-0 bg-white flex justify-end p-2 border-t items-center gap-2">
                        <button class="closebtn bg-gray-200 font-semibold hover:bg-gray-300 px-4 py-2 rounded-lg">Cancel</button>
                        <button class="bg-violet-600 text-white font-semibold hover:bg-violet-800 px-4 py-2 rounded-lg" onclick="filterAll()">Filter</button>
                    </div>
                </div>
            </div>
            <input type="text" autocomplete="search" name="search" value="{{search}}" id="search" class="block w-[300px] rounded-md px-4 py-2 text-black" placeholder="Search title...">
        </div>
    </div>
    <table class="w-full text-left">
        <thead class="bg-violet-600">
            <tr>
                <th class="px-4 py-3">Title</th>
                <th class="px-4 py-3">Categories</th>
                <th class="px-4 py-3">Status</th>
                <th class="px-4 py-3">Date</th>
                <th class="px-4 py-3">Ticket Type</th>
                <th class="px-4 py-3">Option</th>
            </tr>
        </thead>

        <tbody class="divide-y">
            {% for event in event_list %}
            <!-- <tr class="{% if event.status == 'upcoming' %}bg-orange-500/20 {% endif %}"> -->
            <tr>
                <td class="px-4 py-5">{{ event.title }}</td>
                <td class="px-4 py-5">
                    {% if event.category_name|length == 0 %}
                        <p class="text-white">
                            -
                        </p>
                    {% else %}
                        {% for cat in event.category_name %}
                        <span class="border border border-yellow-400 text-yellow-500 mr-2 p-1 rounded-md">
                            {{ cat }}
                        </span>
                        {% endfor %}
                    {% endif %}
                </td>
                <td class="px-4 py-5">{{ event.status }}</td>
                <td class="px-4 py-5">{{ event.date }}</td>
                <td class="px-4 py-5">
                    {% if event.ticket_name|length == 0 %}
                        <p class="text-white">
                            -
                        </p>
                    {% else %}
                        {% for tic in event.ticket_name %}
                        <span class="border border border-yellow-400 text-yellow-500 mr-2 p-1 rounded-md">
                            {{ tic }}
                        </span>
                        {% endfor %}
                    {% endif %}
                </td>
                <td class="px-4 py-5">
                    {% if event.status == "draft" %}
                    <div class="flex gap-3 items-center">
                        <a href="{% url 'organizer-edit-event' id=event.id %}"
                            class="bg-yellow-600 py-1 px-4 rounded-lg font-semibold hover:bg-yellow-700 text-white">
                            Edit
                        </a>
                        <a href="">
                            <img src="{% static 'images/delete.png' %}" alt="delete event" class="w-[25px]">
                        </a>
                    </div>
                    {% else %}
                    <a href=""
                        class="bg-violet-600 py-1 px-4 rounded-lg font-semibold hover:bg-violet-800 text-white">
                        Detail
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center text-gray-400 px-4 py-6">No events found.</td>
            </tr>
            {% endfor %}

        </tbody>
    </table>
</div>
{% endblock %}

{% block script %}
<script>
    const dropdownbtn = document.getElementById("dropdownbtn")
    const dropdownmenu = document.getElementById("dropdownmenu")
    const closebtn = document.querySelectorAll(".closebtn")
    const clearbtn = document.getElementById("clearbtn")

    const price_filter = document.getElementsByName("price-filter")
    const checkboxs = dropdownmenu.querySelectorAll('input[type="checkbox"][name="category-filter"]')

    const search = document.getElementById("search")

    let typingTimer
    const doneTypingInterval = 500

    dropdownbtn.addEventListener("click", () => {
        dropdownmenu.classList.toggle("hidden")
    })
    closebtn.forEach(btn => {
        btn.addEventListener("click", () => {
            dropdownmenu.classList.add("hidden")
        })
    })

    clearbtn.addEventListener("click", () => {
        checkboxs.forEach(cb => cb.checked = false)
    })

    if (search.value !== "") {
        const endPosition = search.value.length
        search.setSelectionRange(endPosition, endPosition) // (start, end) => hello (1, endPosition) => คลุม ello + พิมพ์ต่อ h
    }

    search.addEventListener("keyup", () => {
        clearTimeout(typingTimer)
        typingTimer = setTimeout(filterAll, doneTypingInterval)
    })

    function filterAll() {
        let priceFilter = ""
        price_filter.forEach((value, index) => {
            priceFilter = value.checked ? value.value : priceFilter
        })

        let categoryFilter = []
        checkboxs.forEach(cb => {
            if (cb.checked) categoryFilter.push(cb.value)
        })
        window.location.href = `{% url 'organizer-home' %}?search=${search.value}&price=${priceFilter}&category=${categoryFilter}`
    }
    if (search.value) search.focus()
</script>
{% endblock %}